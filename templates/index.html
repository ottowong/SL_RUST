<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SADLADS RUST MAP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body><div id = "main">
    <h1>{{ name }}</h1>
    <p id="time">Current time: {{ time }}</p>
    <!-- do some quirky javascript to guess the current time base off of the initial one. So that we don't spam requests -->
    <ul id="device_list">
        {% for i in range(0, len) %}
            <li id="{{ devices[i][0] }}">{{ devices[i][1] }}</li>
        {% endfor %}
    </ul>
    <canvas id="map_canvas"></canvas>
    <script>
        function createImage(url) {
            var img = new Image();
            img.src = url;
            return img;
        }

        var canvas = document.getElementById('map_canvas');
        canvas.style.background = "#0b3a4a"
        var ctx = canvas.getContext('2d');
        var img = new Image();
        var shop = new Image();
        var redx = new Image();
        var explosion = new Image();
        var ch47 = new Image();
        var cargo = new Image();
        var crate = new Image();
        var genrad = new Image();
        var patrol = new Image();
        img.src = "{{ url_for('static', filename='map.png') }}";
        redx.src = "{{ url_for('static', filename='redx.png') }}";
        shop.src = "{{ url_for('static', filename='shop.png') }}";
        explosion.src = "{{ url_for('static', filename='explosion.png') }}";
        ch47.src = "{{ url_for('static', filename='ch47.png') }}";
        cargo.src = "{{ url_for('static', filename='cargo.png') }}";
        crate.src = "{{ url_for('static', filename='crate.png') }}";
        genrad.src = "{{ url_for('static', filename='genrad.png') }}";
        patrol.src = "{{ url_for('static', filename='patrol.png') }}";

        let cameraOffset = { x: window.innerWidth/2, y: window.innerHeight/2 }
        let cameraZoom = 1
        let MAX_ZOOM = 5
        let MIN_ZOOM = 0.1
        let SCROLL_SENSITIVITY = 0.001
        let all_markers = []

        function draw()
        {
            canvas.width = window.innerWidth
            canvas.height = window.innerHeight
            
            ctx.translate( window.innerWidth / 2, window.innerHeight / 2 )
            ctx.scale(cameraZoom, cameraZoom)
            ctx.translate( -window.innerWidth / 2 + cameraOffset.x, -window.innerHeight / 2 + cameraOffset.y )
            ctx.drawImage(img, 0,0);
            all_markers.forEach(marker => {
                let x = (marker[1] / 4500 * 2000) - 16;
                let y = (2000 - marker[2] / 4500 * 2000) - 16;
                let angleInRadians = (marker[3] * Math.PI / 180) * -1; // Convert degrees to radians
                ctx.save(); // Save the current context state
                ctx.translate(x, y); // Translate to the marker position
                ctx.rotate(angleInRadians); // Rotate by the specified angle
                switch (marker[0]) {
                    case 1: // player
                        if (marker[4]) {
                            var playerImage = createImage(marker[4]);
                            // crop to be a circle
                            ctx.save(); 
                            ctx.beginPath();
                            ctx.arc(16, 16, 16, 0, Math.PI * 2);
                            ctx.closePath();
                            ctx.clip();
                            ctx.drawImage(playerImage, 0, 0, 32, 32);
                            ctx.restore();
                        }
                        break;
                    case 2: // explosion
                        ctx.drawImage(explosion, 0, 0);
                        break;
                    case 3: // shop
                        ctx.drawImage(shop, 0, 0);
                        break;
                    case 4: // CH47
                        ctx.drawImage(ch47, 0, 0);
                        break;
                    case 5: // cargo ship
                    // console.log(angleInRadians)
                        ctx.drawImage(cargo, 0, 0);
                        break;
                    case 6: // crate
                        ctx.drawImage(crate, 0, 0);
                        break;
                    case 7: // generic radius (whats that???)
                        ctx.drawImage(genrad, 0, 0);
                        break;
                    case 8: // patrol helicopter
                        ctx.drawImage(patrol, 0, 0);
                        break;
                    default:
                        ctx.drawImage(redx, 0, 0);
                }
                ctx.restore();
            });
            ctx.beginPath();
            requestAnimationFrame( draw )
        }

        function getEventLocation(e)
        {
            if (e.touches && e.touches.length == 1)
            {
                return { x:e.touches[0].clientX, y: e.touches[0].clientY }
            }
            else if (e.clientX && e.clientY)
            {
                return { x: e.clientX, y: e.clientY }        
            }
        }

        let isDragging = false
        let dragStart = { x: 0, y: 0 }

        function onPointerDown(e)
        {
            isDragging = true
            dragStart.x = getEventLocation(e).x/cameraZoom - cameraOffset.x
            dragStart.y = getEventLocation(e).y/cameraZoom - cameraOffset.y
        }

        function onPointerUp(e)
        {
            isDragging = false
            initialPinchDistance = null
            lastZoom = cameraZoom
        }

        function onPointerMove(e)
        {
            if (isDragging)
            {
                cameraOffset.x = getEventLocation(e).x/cameraZoom - dragStart.x
                cameraOffset.y = getEventLocation(e).y/cameraZoom - dragStart.y
            }
        }

        function handleTouch(e, singleTouchHandler)
        {
            if ( e.touches.length == 1 )
            {
                singleTouchHandler(e)
            }
            else if (e.type == "touchmove" && e.touches.length == 2)
            {
                isDragging = false
                handlePinch(e)
            }
        }

        let initialPinchDistance = null
        let lastZoom = cameraZoom

        function handlePinch(e)
        {
            e.preventDefault()
            
            let touch1 = { x: e.touches[0].clientX, y: e.touches[0].clientY }
            let touch2 = { x: e.touches[1].clientX, y: e.touches[1].clientY }
            
            let currentDistance = (touch1.x - touch2.x)**2 + (touch1.y - touch2.y)**2
            
            if (initialPinchDistance == null)
            {
                initialPinchDistance = currentDistance
            }
            else
            {
                adjustZoom( null, currentDistance/initialPinchDistance )
            }
        }

        function adjustZoom(zoomAmount, zoomFactor)
        {
            if (!isDragging)
            {
                if (zoomAmount)
                {
                    cameraZoom -= zoomAmount
                }
                else if (zoomFactor)
                {
                    console.log(zoomFactor)
                    cameraZoom = zoomFactor*lastZoom
                }
                
                cameraZoom = Math.min( cameraZoom, MAX_ZOOM )
                cameraZoom = Math.max( cameraZoom, MIN_ZOOM )
                
                console.log(zoomAmount)
            }
        }

        canvas.addEventListener('mousedown', onPointerDown)
        canvas.addEventListener('touchstart', (e) => handleTouch(e, onPointerDown))
        canvas.addEventListener('mouseup', onPointerUp)
        canvas.addEventListener('touchend',  (e) => handleTouch(e, onPointerUp))
        canvas.addEventListener('mousemove', onPointerMove)
        canvas.addEventListener('touchmove', (e) => handleTouch(e, onPointerMove))
        canvas.addEventListener( 'wheel', (e) => adjustZoom(e.deltaY*SCROLL_SENSITIVITY))

        draw()

        document.addEventListener('DOMContentLoaded', function() {
            var socket = io();
            socket.on('connect', function() {
                socket.send('Client connected!');
            });
            socket.on('sent_devices', function(devices) {
                var ul = document.getElementById('device_list');
                ul.innerHTML = '';
                devices.forEach(device => {
                    var li = document.createElement('li');
                    li.textContent = device[1];
                    li.setAttribute('data-id', device[0]);
                    ul.appendChild(li);
                });
            });
            socket.on('update_markers', function(markers) {
                all_markers = markers // update global variable, probably a better way of doing this, but the pan/zoom code makes that harder.
            });
        });

    </script>
    <form action="/add_device" method="POST">
        <label for="device_id">Device ID:</label><br>
        <input type="text" id="device_id" name="device_id"><br>
        <label for="device_name">Device Name:</label><br>
        <input type="text" id="device_name" name="device_name"><br><br>
        <input type="submit" value="Submit">
    </form>
</div>
</body>
</html>